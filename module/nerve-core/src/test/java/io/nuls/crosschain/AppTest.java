package io.nuls.crosschain;

import static org.junit.Assert.assertTrue;

import io.nuls.core.crypto.HexUtil;
import io.nuls.core.parse.JSONUtils;
import io.nuls.crosschain.base.model.bo.AssetInfo;
import io.nuls.crosschain.base.model.bo.ChainInfo;
import io.nuls.crosschain.base.model.bo.LedgerAsset;
import io.nuls.crosschain.base.model.bo.txdata.RegisteredChainChangeData;
import io.nuls.ledger.constant.LedgerConstant;
import io.nuls.ledger.utils.LoggerUtil;
import org.junit.Test;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * Unit test for simple App.
 */
public class AppTest 
{
    /**
     * Rigorous Test :-)
     */
    @Test
    public void shouldAnswerWithTrue()
    {
        assertTrue( true );
    }

    private static List<Map<String,Object>> assembleLedgerAsset(List<ChainInfo> chainInfoList) throws Exception{
        List<Map<String,Object>> ledgerAssetList = new ArrayList<>();
        for (ChainInfo chainInfo : chainInfoList){
            for (AssetInfo assetInfo : chainInfo.getAssetInfoList()){
                LedgerAsset ledgerAsset = new LedgerAsset(assetInfo, chainInfo.getChainId());
                ledgerAssetList.add(JSONUtils.json2map(JSONUtils.obj2json(ledgerAsset)));
            }
        }
        return ledgerAssetList;
    }

    @Test
    public void assetUpdateTest() throws Exception {
        String hex = "01000200010100046e756c73000000000000044e554c5300000000615100045649424b065669626f6f6b010800b50004454d43320d45494e535445494e544f4b454e010900b400034d5648094d6f766965436173680108002d00044441545404444154540008005700035452470d546f6b656e52657075626c69630108009200054e41424f580b4e61626f785f546f6b656e0012008f0006584e494e4a410a584e696e6a6153776170011200bb000458544d430b58544d4353574150415050011200000003414359034143590112000100044e554c5300010800b700045a4f5a4f095a6f5a6f746f6b656e0108000400044f4245450b4f6265654e6574776f726b01080005000547616c616e0347414e0112006b00034547520b45676f726173546f6b656e0108009500045449434f0b5449434f4558546f6b656e010800e2000446555345094e69667479667573650108009400034a4449084a4449546f6b656e010800e100045a494e41065a696e6172690108006700034d43500c4d7943727970746f506c61790108009300034b4649094b654669546f6b656e0108005b00034a5454084a757374546573740108005a0004415243480841524348434f494e010a000d0004444154540444415454010800390006476f626c696e06476f626c696e01080037000442434e540842434e546f6b656e010800630003525658055269766558011200bf00034743430e474c4f42414c434f4d4d434f494e010800620003424e4605426f6e466901080060000443424c5406436f62616c740108007100034e4941084e7964726f6e69610112009d0003534d4709536d617567734e4654010800ea00044c414e44094c616e647368617265010800700004525949500b525949504c4154494e554d0108009c00035054450450656574010800e900034d53440d4d6f6e657964656669537761700112001401054f78534744054f78534744010400c600034447500944475041594d454e540112009800074152544445434f074152544445434f010800c4000341564e0c41564e52696368546f6b656e0108009700034e46440f4e6f6e46756e6769626c654465666901080096000454524f5007496e7465726f70010800c200034f4c44084f6c6474696d65720108007700045045455404506565740112007500034d4553084d6573436861696e0108007400034748440b47696674656468616e6473011200ed0005416c6b6f6d05416c6b6f6d0108009f00034b53460c4b6573656646696e616e63650108007200054b544c594f0c4b6174616c796f546f6b656e0112009e00034943480d49646561636861696e636f696e010800eb00035449430e547265617375726549736c616e64010800a000044150504e044150504e0112001901054f78555344054f78555344010400190003545055075450555361617301080015000345485407456172686172740108007c0005534e45475907536f6e65726779010800a800044649524509477265656e46697265010800a70003564e540756454e54494f4e0108001300045045544307506574436f696e010800f20004564f4c5408566f6c74657272610108001100034c4343034c4343000600a400074c4956454e46540c4c6976654e4654546f6b656e0112001200034c4343034c4343010600a30005444546495909446546694661726d73011200f0000255560d556e69747976656e7475726573010800a20003544f4d03544f4d011200800003434254074342546f6b656e010800a90004384249540438626974010800ab0003474d580547616d6558010800aa000354584f045465786f010800210006476f626c696e06476f626c696e0108004d000443524f530963726f735f74657374000800b300044e465443094e4654436972636c65010200b2000357485806574849544558010800850003464d500e42697473466c65615f506f696e74010400b10003444e4604444e465401120084000353484406534849454c44010800b000035052420c5072656d69756d426c6f636b0112008300045a45524f0a5a45524f5f546f6b656e011200af00044244414d084244414d436f696e0108008200034641520746617253776170011200ae000358594c0378796c011200ac00044343464910436c6f7564436f696e46696e616e63650108008b0003566f7803566f780112008800044747544b074747546f6b656e010800c9010341435903414359011200cd02054e53574150074e756c73776170000800030303484241114865726f6573426174746c654172656e610112000c03054e4445524908446572694e554c530108000d03044e4d46540d4d656d65666c6174654e554c53010800260304504d435408504d43546f6b656e0106001803035754460a576174657254696765720108006503044d4f4c4f074d61784c6f6f70011200a2030569537974680a6953796e746865746963010800ab03057742554c53057742554c530108009200054e41424f580b4e61626f785f546f6b656e011200cd02054e53574150074e756c73776170010800ac03034c4e4c064c756b4e756c01060053254e554c53643648676374447669594b367944424b4a643657476852526b42794c6855727661254e554c536436486761534a32317a74315170706234726275656332416b7561514c676e6b38254e554c53643648676a484c6e6150647950594144535a793955716577764a46456b41555031254e554c5364364867694464546a63757668717a6d33626f6d7942465a6d6f73563365693535254e554c53643648675a5a697159534469797a3378474e34747a4e686772686f39454e353948254e554c53643648676237535638393167637531464232563670524476535563666437356f36254e554c53643648676137704476774a6551337566656e33727562656b6b444674574e5a4467254e554c536436486768355675704a4a37457661627639515132507374386d6a505334645854254e554c5364364867684d724e324454566d634267696f6d4b68765545546b673663364e3845254e554c5364364867684d357779566a656742614473436b57396476426e6b757563656a7877254e554c536436486769724a52356933536b7741444639365148503675684c76424845327951254e554c53643648675a4263773838516b4e656e3177644d374556614a3539356b6b4864644e254e554c53643648676566534d36526b5552546457753169396d423936756647667871673731254e554c53643648675831624e61703744785566746563796d654237566a64487a3448764b55254e554c5364364867644d5a36667a5570346d7938566b617363765778324c634b4a4e464d70254e554c536436486762686b4779787a76766f736e525957676e4c41757343755772744c4e54254e554c536436486761705639765153354e4b43614a534d57613275486757785831336e474a254e554c53643648676554726f4d68334d353968624d577165597162675658696f61384a6d7a254e554c53643648676a3536536f746e6b3238716e52576f6551324577334b755041586e7067254e554c536436486762426d46706f6d4775766d53613736646972747a41743272574b6e3477254e554c536436486767706a4d3852423557626a7a4c6337624c7651446a487552636f6e674e254e554c5364364867664c54336e6d627874485a6d3843736954776a73314878584a746d4454254e554c5364364867594537414b4a6d6b416f50746a58785348506b71787a6d795065626b54254e554c53643648675757456d5a53786666634e564863316b6a6265626b656a576a56747056254e554c53643648675537647347476276575a4246636e4c6a47694a487a375a41387836746f254e554c53643648676355513470614e6a42695253586576777059476856566e7677646b7338254e554c53643648675536357858675752326a7258454b77586976516a365743425956686f41254e554c53643648675a655152756878585a624341454c59484e56456d38627653554c523237254e554c53643648675a69765876587334737536637579467a677442546b6b39665471787979254e554c53643648676677545a4b714b566e5633617769444b6e45624637526a5a756657434e254e554c5364364867577947594c4d4c3543616452694e4435524a676859633576626979634a254e554c53643648676876354351645177666a4154747737364d7557546e5037445434784552254e554c5364364867644e756d414e6457334c7842374e455a64346f61376f7452344c6b504e254e554c536436486756726677786e6d6837796342646443384e4451354c71447a36764b3639254e554c5364364867657a693679374c43525734694c7258454c7976483336664e313277484b254e554c536436486769513543546b6f375a7835397663426548797850414a51375038543438254e554c536436486759324c69794544764d6a7348715a7079616a78535845676b316d637873254e554c536436486764634a6e6b315231387653373344476a33384574574d4d6469706f6759254e554c5364364867657463536b33635a7a35707339326d51557a6170745578763657526354254e554c5364364867573576563431354d4e6f59324a5443617861374e68636148536f384667254e554c5364364867594c6f3568504e6367714b744e74704138646843335933377635526139254e554c536436486757544b624437594241417650374e6a4b696b346e525775537737364e79254e554c5364364867687067394e6b37424e727341636356343946415679764d714356576e76254e554c536436486763704b637859466b65524467384d4a72534546314131536b48324b524d254e554c53643648676438314365324871556d674678774c7677504e586b6e476261614e4d75254e554c53643648676352356f756831614455336f6b74456f4a4751436f6e6a347372314b52254e554c53643648676335564e5034724634777864695845514b70424b554534773552533232254e554c5364364867635847467334365562794e4455614c7545344176694635474354627968254e554c53643648675954776944576d697346447167447a634b38536631393747334c32385a254e554c536436486761346d516b48416e51646855694d6d763156336b51346138344a615362254e554c536436486768707564356f444a364650584e774c6969553878727971453173596d76254e554c536436486758615a555944793844436f70474d7745506e657276674b627471464453254e554c53643648676a46386943726a70796d4679364c56526d456a51473841466179464469254e554c53643648676a4b47586736646b314b3776616766346b4c446b7466374477736f5867254e554c536436486769434356795a7673313632574e5336477a7666323261464e3859343750254e554c53643648676535654741617279684151745a6a4878534e773171774474484152484a254e554c5364364867675131784d617757544d577950744b5763694d665234435461764c7270254e554c53643648676263575a417853476633384a7858396f704b776756754336423848696e254e554c536436486758666e4443697a476a4c664278726b563539574e347554477a484d6469254e554c5364364867624a6d5565703477797265676848446b32384175735343725375444d46254e554c536436486768726859614d645263736b506b4d3876423635585839763838454a4576254e554c536436486757765a555a54527a5455524d3868526d574276707a566d48544231676e254e554c536436486758685554434b4745774869476d6e506d574641765879414e54646a726e254e554c536436486765377848446e767353706e7a6252326757486433317a4a31486f773131254e554c53643648676959484b315757654e576b314478317755623175735158515869633131254e554c5364364867686e5833586e754646544c667a783654457a4d735836524b655a577375254e554c536436486761704569536b31504d59425a74625742524d6343796a6d3756676a7269254e554c536436486758346d426f3576396e7745535277466e394e73394c557159414539314c254e554c5364364867634337384d6155773774446f3838726d673631744843765a6f45615850254e554c5364364867584e724664394e4a4d4635457875536e4774654b6748534b73666d5858254e554c53643648675a635035483846673479355766384177695a386e5668565a346a426353254e554c53643648675a62746e504b627857416867393934484e514737367753733452415071254e554c53643648676831484632776d745252545a547759695655475672694a6e6d38556373254e554c53643648675a4451696650455858546d556132527a4c4c437253346b7a6175663543254e554c5364364867654c7573465261414a4e6b52396f666d355278333246317768704b6534254e554c5364364867665662476b6d71434431796343506a325a4d4a3768594c72427536654d254e554c5364364867666434483238714743727a4764686758324735504b6a3672656a735547254e554c5364364867655177584c647265363941726b71565a4e44714d4c55344361417a3333254e554c536436486756746d485751734b69647148755442316356396b4750566369584e586b254e554c5364364867567367634b364d74346350797950425a39756d5a6e6163623762417237254e554c5364364867686358617747427a77617566456f48636868574a72734a775373697459254e554c53643648676767666552436a78354b61344c565275673469367135796d6661616738254e554c5364364867636a414b416771386a6a58674243634e4c454a55764a4559636f6a3434";
        RegisteredChainChangeData data = new RegisteredChainChangeData();
        data.parse(HexUtil.decode(hex), 0);
        List<Map<String, Object>> maps = assembleLedgerAsset(data.getChainInfoList());

        Map params = new HashMap();
        params.put("chainId", 9);
        params.put("assetType", 3);
        params.put("crossChainAssetList", maps);

        crossChainAssetListReg(params);

        /*ChainInfo chainInfo = data.getChainInfoList().get(0);
        List<AssetInfo> assetInfoList = chainInfo.getAssetInfoList();
        for (AssetInfo assetInfo : assetInfoList) {
            System.out.println(String.format(
                    JSONUtils.obj2json(assetInfo)
            ));
        }
        System.out.println();*/
    }

    public static void crossChainAssetListReg(Map params) {
        Map<String, Object> rtMap = new HashMap<>(3);
        try {
            System.out.println("[register] cross chain asset list");
            int chainId = Integer.parseInt(params.get("chainId").toString());
            short assetType = Short.parseShort(params.get("assetType").toString());
            List<io.nuls.ledger.model.po.LedgerAsset> saveAssetList = new ArrayList<>();
            List<String> deleteAssetKeyList = new ArrayList<>();
            List<Map<String, Object>> list = (List<Map<String, Object>>) params.get("crossChainAssetList");
            System.out.println("crossChainAssetList size: " + list.size());
            Map<String, Map<String, Object>> dataMap = new HashMap<>();
            for(Map<String, Object> assetMap : list) {
                String key = assetMap.get("assetChainId").toString() + "-" + assetMap.get("assetId").toString();
                dataMap.put(key, assetMap);
            }
            System.out.println("dataMap size: " + dataMap.size());
            boolean usable;
            for(Map<String, Object> assetMap : dataMap.values()) {
                int assetChainId = Integer.parseInt(assetMap.get("assetChainId").toString());
                // When an in chain asset is registered as a cross chain asset, the cross chain module will register the asset as a cross chain asset and notify the ledger. At this time, the ledger should be ignored and the asset should not be modified as a cross chain asset
                if (assetType == 3 && chainId == assetChainId) {
                    continue;
                }
                usable = (boolean) assetMap.get("usable");
                if (usable) {
                    io.nuls.ledger.model.po.LedgerAsset asset = new io.nuls.ledger.model.po.LedgerAsset();
                    assetMap.put("chainId", assetMap.get("assetChainId"));
                    asset.map2pojo(assetMap, assetType);
                    saveAssetList.add(asset);
                } else {
                    deleteAssetKeyList.add(assetMap.get("assetChainId").toString() + LedgerConstant.DOWN_LINE + assetMap.get("assetId").toString());
                }
            }
            for (io.nuls.ledger.model.po.LedgerAsset asset : saveAssetList) {
                System.out.println(JSONUtils.obj2json(asset));
            }
            for (String asset : deleteAssetKeyList) {
                System.out.println(asset);
            }
            rtMap.put("value", true);
        } catch (Exception e) {
            LoggerUtil.COMMON_LOG.error(e);
            rtMap.put("value", false);
        }
    }
}
